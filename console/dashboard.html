<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NobleMind Console</title>
  <link rel="icon" href="/favicon.ico" sizes="32x32">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-dark: #0d0d0d;
      --bg-panel: #1a1a1a;
      --bg-card: rgba(10, 17, 40, 0.96);
      --text-primary: #f5f5f5;
      --text-secondary: #a0a0a0;
      --text-muted: #888;
      --border-color: #2a2a2a;
      --border-glass: rgba(148, 163, 184, 0.25);
      --accent: #06FFA5;
      --accent-soft: rgba(6, 255, 165, 0.18);
      --accent-glow: rgba(6, 255, 165, 0.5);
      --accent-blue: #5ee5ff;
      --accent-blue-glow: rgba(94, 229, 255, 0.5);
      --glass-blur: blur(12px);
      --radius-card: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', -apple-system, Arial, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding: 24px;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 0;
      background:
        radial-gradient(circle at top, rgba(6,255,165,0.10), transparent 50%),
        radial-gradient(circle at bottom right, rgba(94,229,255,0.08), transparent 50%);
      pointer-events: none;
    }

    .container {
      max-width: 1300px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-area h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 0 25px var(--accent-glow);
    }

    .logo-area .badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--accent);
      background: rgba(6,255,165,0.1);
      border: 1px solid rgba(6,255,165,0.3);
      padding: 3px 10px;
      border-radius: 6px;
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    select, button {
      background: rgba(13, 13, 13, 0.6);
      backdrop-filter: var(--glass-blur);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.25s ease;
      font-family: inherit;
    }

    select:hover, button:hover {
      border-color: var(--accent);
      box-shadow: 0 0 20px var(--accent-glow);
    }

    .refresh-btn {
      background: linear-gradient(135deg, var(--accent), #22c55e);
      color: #020617;
      font-weight: 600;
      border: none;
      box-shadow: 0 0 20px rgba(6,255,165,0.3);
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 35px rgba(6,255,165,0.5);
    }

    /* Glass Card — the core component */
    .card {
      background: linear-gradient(135deg, rgba(10,17,40,0.7), rgba(13,13,13,0.7));
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-card);
      padding: 22px 26px;
      position: relative;
      overflow: hidden;
      transition: all 0.25s ease;
    }

    .card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 60px;
      background: radial-gradient(ellipse at top, rgba(6,255,165,0.06), transparent 70%);
      opacity: 0;
      transition: opacity 0.25s ease;
      pointer-events: none;
    }

    .card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 30px var(--accent-glow);
    }

    .card:hover::before {
      opacity: 1;
    }

    .card h3 {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-shadow: 0 0 10px var(--accent-glow);
    }

    .card canvas {
      max-height: 300px;
    }

    /* Summary cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .summary-card {
      background: linear-gradient(135deg, rgba(10,17,40,0.7), rgba(13,13,13,0.7));
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-card);
      padding: 22px 26px;
      position: relative;
      overflow: hidden;
      transition: all 0.25s ease;
    }

    .summary-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-blue));
      opacity: 0.5;
      transition: opacity 0.25s ease;
    }

    .summary-card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 30px var(--accent-glow);
    }

    .summary-card:hover::before {
      opacity: 1;
    }

    .summary-card .label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .summary-card .value {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 0 20px var(--accent-glow);
    }

    .summary-card.blue .value {
      color: var(--accent-blue);
      text-shadow: 0 0 20px var(--accent-blue-glow);
    }

    .live-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 12px var(--accent-glow);
      animation: pulse 2s infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Layout grid */
    .grid-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .grid-row.two-col { grid-template-columns: 1fr 1fr; }
    .grid-row.three-col { grid-template-columns: 1fr 1fr 1fr; }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
      padding: 8px 8px;
      border-bottom: 1px solid var(--border-color);
    }

    td {
      padding: 9px 8px;
      border-bottom: 1px solid rgba(42, 42, 42, 0.4);
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    tr:last-child td { border-bottom: none; }

    tr:hover td {
      background: rgba(6, 255, 165, 0.03);
    }

    .mono {
      font-family: 'Courier New', 'Consolas', monospace;
      font-size: 0.82rem;
      color: var(--accent);
    }

    .count-cell {
      text-align: right;
      font-weight: 600;
      color: var(--text-primary);
    }

    .bar-cell {
      width: 100px;
      padding-left: 10px;
    }

    .bar-bg {
      height: 5px;
      background: rgba(42, 42, 42, 0.8);
      border-radius: 3px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-blue));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    /* Visitor hash badge */
    .visitor-id {
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      color: var(--accent-blue);
      background: rgba(94, 229, 255, 0.08);
      border: 1px solid rgba(94, 229, 255, 0.2);
      padding: 2px 7px;
      border-radius: 4px;
    }

    /* Country badge */
    .country-badge {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
      background: rgba(6, 255, 165, 0.1);
      border: 1px solid rgba(6, 255, 165, 0.2);
      padding: 2px 8px;
      border-radius: 4px;
    }

    /* Browser/device/os badges in recent table */
    .info-badge {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 1px 6px;
      border-radius: 3px;
      margin-right: 4px;
    }

    /* Timestamp in recent log */
    .ts {
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* Event badges */
    .event-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 0.78rem;
      font-weight: 600;
    }

    .event-badge.pwa_install {
      background: rgba(6, 255, 165, 0.12);
      color: var(--accent);
      border: 1px solid rgba(6, 255, 165, 0.3);
    }

    .event-badge.pwa_prompt {
      background: rgba(94, 229, 255, 0.12);
      color: var(--accent-blue);
      border: 1px solid rgba(94, 229, 255, 0.3);
    }

    .event-badge.file_download {
      background: rgba(168, 85, 247, 0.12);
      color: #c084fc;
      border: 1px solid rgba(168, 85, 247, 0.3);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 32px;
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
    }

    /* Scrollable recent visitors */
    .recent-scroll {
      max-height: 500px;
      overflow-y: auto;
    }

    .recent-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .recent-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .recent-scroll::-webkit-scrollbar-thumb {
      background: rgba(6, 255, 165, 0.25);
      border-radius: 3px;
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 32px;
      padding-top: 20px;
      border-top: 1px solid rgba(148,163,184,0.1);
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .grid-row.two-col,
      .grid-row.three-col { grid-template-columns: 1fr; }
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
      header { flex-direction: column; align-items: flex-start; }
      .recent-scroll { overflow-x: auto; }
    }

    @media (max-width: 480px) {
      body { padding: 12px; }
      .summary-grid { grid-template-columns: 1fr; }
      .summary-card .value { font-size: 1.8rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-area">
        <h1>NobleMind Console</h1>
        <span class="badge">Analytics</span>
      </div>
      <div class="controls">
        <select id="periodSelect">
          <option value="1">Today</option>
          <option value="7" selected>7 days</option>
          <option value="30">30 days</option>
          <option value="90">90 days</option>
        </select>
        <button class="refresh-btn" onclick="loadData()">Refresh</button>
      </div>
    </header>

    <!-- Summary Cards -->
    <div class="summary-grid">
      <div class="summary-card">
        <div class="label">Total Views</div>
        <div class="value" id="totalViews">--</div>
      </div>
      <div class="summary-card blue">
        <div class="label">Unique Visitors</div>
        <div class="value" id="uniqueVisitors">--</div>
      </div>
      <div class="summary-card">
        <div class="label">Active Now</div>
        <div class="value"><span class="live-dot"></span><span id="activeNow">--</span></div>
      </div>
      <div class="summary-card blue">
        <div class="label">Avg. Daily Views</div>
        <div class="value" id="avgDaily">--</div>
      </div>
    </div>

    <!-- Recent Visitors -->
    <div class="grid-row">
      <div class="card">
        <h3>Recent Visitors</h3>
        <div class="recent-scroll" id="recentVisitors"></div>
      </div>
    </div>

    <!-- Time Series Chart -->
    <div class="grid-row">
      <div class="card">
        <h3>Traffic Over Time</h3>
        <canvas id="timeChart"></canvas>
      </div>
    </div>

    <!-- Top Pages + Referrers -->
    <div class="grid-row two-col">
      <div class="card">
        <h3>Top Pages</h3>
        <div id="topPages"></div>
      </div>
      <div class="card">
        <h3>Top Referrers</h3>
        <div id="topReferrers"></div>
      </div>
    </div>

    <!-- Browser / Device / OS -->
    <div class="grid-row three-col">
      <div class="card">
        <h3>Browsers</h3>
        <canvas id="browserChart"></canvas>
      </div>
      <div class="card">
        <h3>Devices</h3>
        <canvas id="deviceChart"></canvas>
      </div>
      <div class="card">
        <h3>Operating Systems</h3>
        <canvas id="osChart"></canvas>
      </div>
    </div>

    <!-- Countries + Events -->
    <div class="grid-row two-col">
      <div class="card">
        <h3>Countries</h3>
        <canvas id="countryChart"></canvas>
      </div>
      <div class="card">
        <h3>Events</h3>
        <div id="eventsTable"></div>
      </div>
    </div>

    <footer>
      <p>NobleMind Console &mdash; Privacy-first analytics. No cookies. No tracking across days.</p>
      <p style="margin-top:8px">&copy; 2026 Paul Hainline. All rights reserved.</p>
    </footer>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token') || '';
    const baseURL = window.location.origin;

    let timeChart, browserChart, deviceChart, osChart, countryChart;

    Chart.defaults.color = '#a0a0a0';
    Chart.defaults.borderColor = 'rgba(42, 42, 42, 0.6)';
    Chart.defaults.font.family = "'Segoe UI', -apple-system, Arial, sans-serif";

    const accentColors = [
      '#06FFA5', '#5ee5ff', '#c084fc', '#fb923c',
      '#f472b6', '#facc15', '#a3e635', '#38bdf8',
      '#e879f9', '#34d399'
    ];

    async function fetchJSON(url) {
      const sep = url.includes('?') ? '&' : '?';
      const res = await fetch(url + (token ? sep + 'token=' + token : ''));
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    function formatNum(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return String(n);
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // Format UTC timestamp to local date+time
    function formatTime(utcStr) {
      if (!utcStr) return '';
      const d = new Date(utcStr.endsWith('Z') ? utcStr : utcStr + 'Z');
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const year = d.getFullYear();
      let h = d.getHours();
      const m = String(d.getMinutes()).padStart(2, '0');
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return month + '/' + day + '/' + year + ' ' + h + ':' + m + ' ' + ampm;
    }

    // Format date string for chart labels (local timezone)
    function formatChartDate(dateStr) {
      const d = new Date(dateStr + 'T12:00:00');
      return (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear();
    }

    function buildTable(items) {
      if (!items || items.length === 0) return '<div class="empty-state">No data yet</div>';
      const max = Math.max(...items.map(i => i.count));
      return '<table>' +
        '<tr><th>Name</th><th style="text-align:right">Count</th><th></th></tr>' +
        items.map(item => {
          const pct = max > 0 ? (item.count / max * 100) : 0;
          return '<tr>' +
            '<td class="mono">' + escapeHtml(item.name || '(direct)') + '</td>' +
            '<td class="count-cell">' + formatNum(item.count) + '</td>' +
            '<td class="bar-cell"><div class="bar-bg"><div class="bar-fill" style="width:' + pct + '%"></div></div></td>' +
          '</tr>';
        }).join('') +
        '</table>';
    }

    function buildRecentTable(visits) {
      if (!visits || visits.length === 0) return '<div class="empty-state">No visits recorded yet</div>';
      return '<table>' +
        '<tr><th>Time</th><th>IP</th><th>Location</th><th>Device</th><th>Referrer</th><th>Path</th></tr>' +
        visits.map(v => {
          const locParts = [v.city, v.region, v.country].filter(Boolean);
          const location = locParts.length > 0 ? locParts.join(', ') : '--';
          const device = [v.browser, v.os, v.device].filter(Boolean).join(' / ');
          return '<tr>' +
            '<td class="ts">' + formatTime(v.timestamp) + '</td>' +
            '<td class="mono">' + escapeHtml(v.ip_address || '--') + '</td>' +
            '<td>' + (locParts.length > 0 ? '<span class="country-badge">' + escapeHtml(location) + '</span>' : '<span style="color:#555">--</span>') + '</td>' +
            '<td><span class="info-badge">' + escapeHtml(device || '--') + '</span></td>' +
            '<td style="color:var(--text-muted);font-size:0.8rem">' + escapeHtml(v.referrer || '') + '</td>' +
            '<td class="mono">' + escapeHtml(v.path) + '</td>' +
          '</tr>';
        }).join('') +
        '</table>';
    }

    function createDoughnut(ctx, labels, data) {
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: accentColors.slice(0, data.length),
            borderWidth: 0,
            hoverOffset: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '55%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { padding: 12, usePointStyle: true, pointStyle: 'circle' }
            }
          }
        }
      });
    }

    function destroyCharts() {
      [timeChart, browserChart, deviceChart, osChart, countryChart].forEach(c => { if (c) c.destroy(); });
    }

    async function loadData() {
      const period = document.getElementById('periodSelect').value;

      try {
        const [stats, realtime, recent] = await Promise.all([
          fetchJSON(baseURL + '/api/analytics/stats?period=' + period + 'd'),
          fetchJSON(baseURL + '/api/analytics/realtime'),
          fetchJSON(baseURL + '/api/analytics/recent?limit=100')
        ]);

        // Summary cards
        document.getElementById('totalViews').textContent = formatNum(stats.total_views || 0);
        document.getElementById('uniqueVisitors').textContent = formatNum(stats.unique_visitors || 0);
        document.getElementById('activeNow').textContent = String(realtime.active_visitors || 0);

        const days = parseInt(period) || 7;
        const avg = days > 0 ? Math.round((stats.total_views || 0) / days) : 0;
        document.getElementById('avgDaily').textContent = formatNum(avg);

        // Recent visitors
        document.getElementById('recentVisitors').innerHTML = buildRecentTable(recent);

        // Destroy old charts
        destroyCharts();

        // Time series — format dates for local timezone
        const ts = stats.time_series || [];
        timeChart = new Chart(document.getElementById('timeChart'), {
          type: 'line',
          data: {
            labels: ts.map(t => formatChartDate(t.date)),
            datasets: [
              {
                label: 'Page Views',
                data: ts.map(t => t.views),
                borderColor: '#06FFA5',
                backgroundColor: 'rgba(6, 255, 165, 0.08)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#06FFA5',
                borderWidth: 2
              },
              {
                label: 'Unique Visitors',
                data: ts.map(t => t.uniq),
                borderColor: '#5ee5ff',
                backgroundColor: 'rgba(94, 229, 255, 0.08)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#5ee5ff',
                borderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: { intersect: false, mode: 'index' },
            scales: {
              x: { grid: { color: 'rgba(42,42,42,0.4)' } },
              y: { beginAtZero: true, grid: { color: 'rgba(42,42,42,0.4)' },
                ticks: { stepSize: 1 } }
            },
            plugins: {
              legend: { labels: { usePointStyle: true, pointStyle: 'circle' } },
              tooltip: {
                callbacks: {
                  title: function(items) { return items[0].label; }
                }
              }
            }
          }
        });

        // Top pages & referrers
        document.getElementById('topPages').innerHTML = buildTable(stats.top_pages);
        document.getElementById('topReferrers').innerHTML = buildTable(stats.top_referrers);

        // Doughnut charts
        const b = stats.browsers || [];
        if (b.length > 0) {
          browserChart = createDoughnut(document.getElementById('browserChart'), b.map(x => x.name), b.map(x => x.count));
        }

        const d = stats.devices || [];
        if (d.length > 0) {
          deviceChart = createDoughnut(document.getElementById('deviceChart'), d.map(x => x.name), d.map(x => x.count));
        }

        const o = stats.os_stats || [];
        if (o.length > 0) {
          osChart = createDoughnut(document.getElementById('osChart'), o.map(x => x.name), o.map(x => x.count));
        }

        // Countries bar chart
        const c = stats.countries || [];
        if (c.length > 0) {
          countryChart = new Chart(document.getElementById('countryChart'), {
            type: 'bar',
            data: {
              labels: c.map(x => x.name),
              datasets: [{
                data: c.map(x => x.count),
                backgroundColor: accentColors.slice(0, c.length),
                borderWidth: 0,
                borderRadius: 4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              indexAxis: 'y',
              scales: {
                x: { beginAtZero: true, grid: { color: 'rgba(42,42,42,0.4)' }, ticks: { stepSize: 1 } },
                y: { grid: { display: false } }
              },
              plugins: { legend: { display: false } }
            }
          });
        }

        // Events table
        const ev = stats.events || [];
        if (ev.length === 0) {
          document.getElementById('eventsTable').innerHTML = '<div class="empty-state">No events yet</div>';
        } else {
          document.getElementById('eventsTable').innerHTML = '<table>' +
            '<tr><th>Event</th><th style="text-align:right">Count</th></tr>' +
            ev.map(e => {
              const cls = e.type.replace(/[^a-z_]/g, '');
              return '<tr><td><span class="event-badge ' + cls + '">' + escapeHtml(e.type) + '</span></td>' +
                '<td class="count-cell">' + formatNum(e.count) + '</td></tr>';
            }).join('') +
            '</table>';
        }

      } catch (err) {
        console.error('Failed to load data:', err);
        document.getElementById('totalViews').textContent = 'Error';
      }
    }

    // Auto-refresh realtime + recent every 30 seconds
    setInterval(async () => {
      try {
        const [rt, recent] = await Promise.all([
          fetchJSON(baseURL + '/api/analytics/realtime'),
          fetchJSON(baseURL + '/api/analytics/recent?limit=100')
        ]);
        document.getElementById('activeNow').textContent = String(rt.active_visitors || 0);
        document.getElementById('recentVisitors').innerHTML = buildRecentTable(recent);
      } catch (e) { /* silent */ }
    }, 30000);

    document.getElementById('periodSelect').addEventListener('change', loadData);
    loadData();
  </script>
</body>
</html>
